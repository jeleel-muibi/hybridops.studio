---
# SPDX-License-Identifier: MIT-0
# Author: Jeleel Muibi (hybridops.studio)
# Created: 2025-09-10 21:15:00 UTC
# Updated: 2025-09-10 â€” Initial host_selector implementation
#
# Purpose: Create dynamic inventory groups for selected hosts.

- name: Validate target hosts exist
  fail:
    msg: "{{ messages.no_hosts }}"
  when: target_hosts | length == 0

- name: Display selected targets
  debug:
    msg: "[cid={{ cid | default('') }}] Selected {{ target_hosts | length }} hosts: {{ target_hosts | join(', ') }}"
    verbosity: 1

- name: Create dynamic group for inventory hosts
  add_host:
    name: "{{ item }}"
    groups: targets_to_ping
    env: "{{ env }}"
    ansible_host: "{{ hostvars[item].ansible_host | default(item) }}"
    environments: "{{ hostvars[item].environments | default({}) }}"
  loop: "{{ target_hosts }}"
  when: item in groups['all']

- name: Create dynamic group for manual entries
  add_host:
    name: "{{ item }}"
    ansible_host: "{{ item }}"
    groups: targets_to_ping
    env: "{{ env }}"
    gather_facts: false
    environments: {}
  loop: "{{ target_hosts }}"
  when: item not in groups['all']

- name: Set output variables
  set_fact:
    selected_hosts: "{{ target_hosts }}"
    selected_count: "{{ target_hosts | length }}"
    host_selector_success: true

- name: Summary
  debug:
    msg: |
      [cid={{ cid | default('') }}]
      Dynamic group 'targets_to_ping' created
      Environment: {{ env }}
      Total: {{ target_hosts | length }}
      Inventory: {{ target_hosts | select('in', groups['all']) | list | length }}
      Manual: {{ target_hosts | reject('in', groups['all']) | list | length }}
