---
# =============================================================================
# Deployment Window Validation (Fixed)
# =============================================================================

- name: "Get deployment window configuration"
  set_fact:
    _window_config: "{{ env_guard.deployment.windows[_resolved_environment.deployment_window] }}"

- name: "Get current time information"
  set_fact:
    _current_day: "{{ _current_datetime.weekday_name }}"
    _current_time: "{{ _current_datetime.time }}"

- name: "Evaluate deployment window"
  set_fact:
    _window_check:
      permitted: "{{ _window_permitted }}"
      window_type: "{{ _resolved_environment.deployment_window }}"
      current_day: "{{ _current_day }}"
      current_time: "{{ _current_time }}"

- name: "Deployment window status"
  debug:
    msg: |
      â° DEPLOYMENT WINDOW VALIDATION
      â”œâ”€â”€ Current: {{ _current_time }} {{ _current_day | title }}
      â”œâ”€â”€ Allowed: {{ _window_config.days | join(', ') | title }} {{ _window_config.hours.start }}-{{ _window_config.hours.end }}
      â”œâ”€â”€ Window Type: {{ _resolved_environment.deployment_window }}
      â””â”€â”€ Status: {{ 'PERMITTED' if _window_check.permitted else 'RESTRICTED' }}

- name: "Enforce production deployment window"
  fail:
    msg: |
      âŒ PRODUCTION DEPLOYMENT WINDOW VIOLATION

      ğŸ  Homelab production deployments are restricted to maintenance windows.

      ğŸ“… Allowed Times:
      â””â”€â”€ {{ _window_config.days | join(', ') | title }}: {{ _window_config.hours.start }}-{{ _window_config.hours.end }}

      â° Current Time: {{ _current_time }} {{ _current_day | title }}

      ğŸ’¡ Rationale: Production changes during maintenance windows reduce risk
      of impacting running services during active usage periods.

      Please wait for the next maintenance window or temporarily modify
      the deployment window configuration for emergency deployments.
  when:
  - _canonical_env == 'production'
  - not (_window_check.permitted | bool)
