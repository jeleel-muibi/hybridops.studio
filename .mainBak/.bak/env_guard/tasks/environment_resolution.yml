---
# =============================================================================
# Intelligent Environment Resolution Engine (Fixed)
# =============================================================================

- name: "ğŸ” Capture original environment input"
  set_fact:
    _original_env: "{{ env | default(target_env | default('dev')) | lower | trim }}"

- name: "ğŸ” Build environment lookup table"
  set_fact:
    _env_lookup: "{{ _environment_resolver | from_yaml }}"

- name: "ğŸ” Resolve canonical environment name"
  set_fact:
    _canonical_env: >-
      {%- if _original_env in env_guard.environments.keys() -%}
        {{ _original_env }}
      {%- elif _original_env in _env_lookup.keys() -%}
        {{ _env_lookup[_original_env] }}
      {%- else -%}
        dev
      {%- endif -%}

- name: "ğŸ” Load resolved environment configuration"
  set_fact:
    _resolved_environment: "{{ env_guard.environments[_canonical_env] | combine({'canonical_name': _canonical_env}) }}"

- name: "ğŸ” Environment resolution summary"
  debug:
    msg: |
      ğŸ  HOMELAB ENVIRONMENT RESOLUTION
      â”œâ”€â”€ Original Input: '{{ _original_env }}'
      â”œâ”€â”€ Canonical Name: '{{ _canonical_env }}'
      â”œâ”€â”€ Risk Level: {{ _resolved_environment.risk_level }}/10
      â”œâ”€â”€ Approval Required: {{ _resolved_environment.approval_required }}
      â”œâ”€â”€ Deployment Window: {{ _resolved_environment.deployment_window }}
      â””â”€â”€ Health Check Timeout: {{ _resolved_environment.health_check_timeout }}s

- name: "âŒ Environment resolution failed"
  fail:
    msg: |
      âŒ ENVIRONMENT RESOLUTION FAILED

      ğŸ  Could not resolve environment: '{{ _original_env }}'

      ğŸ“‹ Supported environments:
      {% for env_name, env_config in env_guard.environments.items() %}
      â”œâ”€â”€ {{ env_name }} (aliases: {{ env_config.aliases | join(', ') }})
      {% endfor %}

      ğŸ’¡ Example usage:
      â””â”€â”€ ansible-playbook playbook.yml -e env=dev

      Please specify a valid environment and try again.
  when: _canonical_env not in env_guard.environments.keys()
