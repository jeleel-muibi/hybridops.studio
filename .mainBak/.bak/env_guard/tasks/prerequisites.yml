---
# =============================================================================
# Framework Prerequisites and Health Checks (Fixed)
# =============================================================================

- name: "ğŸ” Validate framework prerequisites"
  assert:
    that: "{{ prerequisite.condition }}"
    fail_msg: "âŒ {{ prerequisite.description }}"
    success_msg: "âœ… {{ prerequisite.description }}"
  loop:
  - description: "Environment parameter provided"
    condition: "env is defined and env != ''"

  - description: "Supported environment specified"
    condition: "env in env_guard.environments.keys() or env in (env_guard.environments.values() | map(attribute='aliases') | flatten)"

  - description: "Ansible facts gathered"
    condition: "ansible_date_time is defined"

  - description: "User context available"
    condition: "ansible_user_id is defined or ansible_env.USER is defined"

  - description: "Framework configuration loaded"
    condition: "env_guard is defined and env_guard.environments is defined"
  loop_control:
    loop_var: prerequisite # â† Fixed: Use unique loop variable
    label: "{{ prerequisite.description }}"

- name: "ğŸ” Environment validation summary"
  debug:
    msg: |
      ğŸ  HOMELAB ENVIRONMENT GUARD - PREREQUISITES âœ…
      â”œâ”€â”€ Framework Version: {{ _env_guard.version }}
      â”œâ”€â”€ Environment Input: {{ env }}
      â”œâ”€â”€ Execution Context: {{ ansible_date_time.iso8601 }}
      â”œâ”€â”€ User: {{ ansible_user_id | default(ansible_env.USER | default('unknown')) }}
      â””â”€â”€ Host: {{ ansible_hostname | default('localhost') }}
