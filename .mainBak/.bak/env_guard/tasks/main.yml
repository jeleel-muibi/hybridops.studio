---
# Environment Guard Framework - Interactive Protection (Built-in Prompts)
# Author: jeleel-muibi | Date: 2025-08-30 21:00:40 UTC

- name: "ğŸ  Environment Guard Framework Starting"
  debug:
    msg: |
      ğŸ  ENVIRONMENT GUARD FRAMEWORK v2.0.0 (Interactive)
      â”œâ”€â”€ Date: {{ ansible_date_time.iso8601 }}
      â”œâ”€â”€ User: {{ ansible_user_id | default('unknown') }}
      â”œâ”€â”€ Mode: Interactive environment selection
      â””â”€â”€ Framework: Starting validation pipeline...

- name: "ğŸ¯ Interactive Environment Selection"
  pause:
    prompt: |

      ğŸ  ENVIRONMENT GUARD - DEPLOYMENT TARGET SELECTION
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ğŸ“‹ Available Deployment Environments:

      ğŸŸ¢ dev        - Development Environment
         â”œâ”€â”€ Risk Level: 1/10 (LOW)
         â”œâ”€â”€ Approval: Auto-approved
         â”œâ”€â”€ Deployment: Immediate
         â””â”€â”€ Impact: Development systems only

      ğŸŸ¡ staging    - Staging Environment
         â”œâ”€â”€ Risk Level: 5/10 (MEDIUM)
         â”œâ”€â”€ Approval: Auto-approved
         â”œâ”€â”€ Deployment: Business hours preferred
         â””â”€â”€ Impact: Pre-production validation

      ğŸ”´ production - Production Environment
         â”œâ”€â”€ Risk Level: 10/10 (HIGH)
         â”œâ”€â”€ Approval: Manual confirmation required
         â”œâ”€â”€ Deployment: Maintenance window required
         â””â”€â”€ Impact: âš ï¸  LIVE CUSTOMER SYSTEMS âš ï¸

      âš ï¸  Choose carefully - this affects real infrastructure!

      Enter environment (dev/staging/production) [default: dev]
  register: environment_selection
  when: env is not defined or env == ""

- name: "ğŸ“Š Set environment from user input or variable"
  set_fact:
    env: "{{ environment_selection.user_input | default(env) | default('dev') }}"

- name: "âŒ Fail if invalid environment"
  fail:
    msg: |
      âŒ ENVIRONMENT GUARD: DEPLOYMENT BLOCKED
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸš¨ ERROR: Invalid environment '{{ env }}'!

      ğŸ“‹ Valid environments: dev, staging, production
      ğŸ’¡ You provided: {{ env }}

      âœ… Valid options:
      â”œâ”€â”€ dev        - Development environment
      â”œâ”€â”€ staging    - Staging environment
      â””â”€â”€ production - Production environment

      ğŸ”„ Please run the playbook again and select a valid environment.
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  when: env not in ['dev', 'staging', 'production']

- name: "ğŸ›¡ï¸ Set environment protection level"
  set_fact:
    env_protection:
      dev:
        risk_level: 1
        approval_required: false
        description: "Development environment - auto-approved"
        color: "ğŸŸ¢"
      staging:
        risk_level: 5
        approval_required: false
        description: "Staging environment - business hours preferred"
        color: "ğŸŸ¡"
      production:
        risk_level: 10
        approval_required: true
        description: "Production environment - manual approval required"
        color: "ğŸ”´"

- name: "ğŸ“Š Calculate deployment risk"
  set_fact:
    current_env_config: "{{ env_protection[env] }}"
    risk_score: "{{ env_protection[env].risk_level }}"
    requires_approval: "{{ env_protection[env].approval_required }}"
    target_host_count: "{{ ansible_play_hosts | length }}"
    env_color: "{{ env_protection[env].color }}"

- name: "ğŸš¨ PRODUCTION DEPLOYMENT WARNING"
  debug:
    msg: |
      ğŸš¨ PRODUCTION DEPLOYMENT DETECTED
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âš ï¸  ENVIRONMENT: {{ env | upper }}
      âš ï¸  RISK LEVEL: {{ risk_score }}/10 (HIGH)
      âš ï¸  TARGET HOSTS: {{ target_host_count }} hosts
      âš ï¸  USER: {{ ansible_user_id | default('unknown') }}
      âš ï¸  TIME: {{ ansible_date_time.iso8601 }}
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      ğŸ”’ Manual approval required for production deployments
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  when: env == 'production'

- name: "ğŸ“ Production Deployment Justification"
  pause:
    prompt: |

      ğŸ“ PRODUCTION DEPLOYMENT JUSTIFICATION REQUIRED
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Environment: {{ env | upper }}
      Risk Level: {{ risk_score }}/10 (HIGH)
      Target Hosts: {{ target_host_count }} hosts
      User: {{ ansible_user_id | default('unknown') }}

      Please provide justification for this production deployment:
      (e.g., "Critical security patch", "Emergency fix", "Scheduled release")

      Justification
  register: production_justification
  when: requires_approval | bool

- name: "ğŸ”’ Production Approval Required"
  pause:
    prompt: |

      ğŸš¨ PRODUCTION DEPLOYMENT APPROVAL REQUIRED
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Environment: {{ env | upper }}
      Risk Level: {{ risk_score }}/10 (HIGH)
      Target Hosts: {{ target_host_count }} hosts
      User: {{ ansible_user_id | default('unknown') }}
      Time: {{ ansible_date_time.iso8601 }}
      Justification: {{ production_justification.user_input | default('Not provided') }}

      âš ï¸  This will deploy to PRODUCTION environment!
      âš ï¸  This action cannot be undone!
      âš ï¸  Live customer systems will be affected!

      To proceed, type 'DEPLOY' (case sensitive)
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  register: production_approval
  when: requires_approval | bool

- name: "âŒ Production deployment cancelled"
  fail:
    msg: |
      âŒ PRODUCTION DEPLOYMENT CANCELLED
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸš« User did not confirm deployment

      You typed: '{{ production_approval.user_input | default('nothing') }}'
      Expected: 'DEPLOY'
      Justification: {{ production_justification.user_input | default('Not provided') }}

      ğŸ’¡ Deployment cancelled for safety
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  when:
  - requires_approval | bool
  - production_approval.user_input != 'DEPLOY'

- name: "âœ… Environment Guard Validation Complete"
  debug:
    msg: |
      âœ… ENVIRONMENT GUARD: DEPLOYMENT APPROVED
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ“… Time: {{ ansible_date_time.iso8601 }}
      {{ env_color }} Environment: {{ env | upper }} ({{ current_env_config.description }})
      âœ… Risk Level: {{ risk_score }}/10
      âœ… User: {{ ansible_user_id | default('unknown') }}
      âœ… Target Hosts: {{ target_host_count }} hosts
      âœ… Approval: {{ 'MANUAL APPROVED' if requires_approval else 'AUTO APPROVED' }}
      {% if production_justification is defined and production_justification.user_input is defined and production_justification.user_input %}
      âœ… Justification: {{ production_justification.user_input }}
      {% endif %}
      âœ… Status: DEPLOYMENT AUTHORIZED
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸš€ Proceeding with deployment...

- name: "ğŸ“Š Set framework variables for other roles"
  set_fact:
    validated_env: "{{ env }}"
    environment_type: "{{ current_env_config.description }}"
    env_guard_risk_score: "{{ risk_score }}"
    env_guard_correlation_id: "envguard-{{ ansible_date_time.epoch }}-{{ 999 | random }}"
    env_guard_version: "2.0.0"
    deployment_justification: "{{ (production_justification.user_input | default('')) if (production_justification is defined) else 'Standard deployment' }}"
    _final_status: "approved"
