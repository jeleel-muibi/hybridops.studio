---
# Test All Environments with Consistent Naming
# Author: jeleel-muibi | Date: 2025-08-31 21:06:39 UTC

- name: Test All Environments (dev, staging, prod)
  hosts: localhost
  gather_facts: true

  tasks:
  - name: "ğŸ¯ Complete Environment Test Starting"
    debug:
      msg: |
        ğŸ¯ COMPLETE ENVIRONMENT TEST
        â”œâ”€â”€ Date: 2025-08-31 21:06:39 UTC
        â”œâ”€â”€ User: jeleel-muibi
        â”œâ”€â”€ Test: All environments with consistent naming
        â””â”€â”€ Environments: dev, staging, prod

  - name: "ğŸ”„ Test all environments with consistent naming"
    include_tasks: test_single_env.yml
    vars:
      test_env: "{{ item }}"
    loop:
    - dev
    - staging
    - prod

  - name: "ğŸ“Š Verify all inventory files"
    stat:
      path: "{{ ansible_env.PWD.split('/hybridops-studio')[0] }}/hybridops-studio/inventories/{{ item }}/hosts.ini"
    register: final_inventory_check
    loop:
    - dev
    - staging
    - prod

  - name: "ğŸ“„ Show prod inventory content preview"
    slurp:
      src: "{{ ansible_env.PWD.split('/hybridops-studio')[0] }}/hybridops-studio/inventories/prod/hosts.ini"
    register: prod_inventory
    when: final_inventory_check.results[2].stat.exists

  - name: "ğŸ‰ Complete Test Results"
    debug:
      msg: |
        ğŸ‰ COMPLETE ENVIRONMENT TEST RESULTS
        â”œâ”€â”€ Project Root: {{ ansible_env.PWD.split('/hybridops-studio')[0] }}/hybridops-studio
        â”œâ”€â”€ DEV: {{ 'âœ… SUCCESS' if final_inventory_check.results[0].stat.exists else 'âŒ FAILED' }}
        â”œâ”€â”€ STAGING: {{ 'âœ… SUCCESS' if final_inventory_check.results[1].stat.exists else 'âŒ FAILED' }}
        â”œâ”€â”€ PROD: {{ 'âœ… SUCCESS' if final_inventory_check.results[2].stat.exists else 'âŒ FAILED' }}
        â”œâ”€â”€ Total Files: {{ final_inventory_check.results | selectattr('stat.exists') | list | length }}/3
        â””â”€â”€ Status: {{ 'ğŸ‰ ALL SUCCESS' if (final_inventory_check.results | selectattr('stat.exists') | list | length == 3) else 'ğŸ’¥ SOME FAILED' }}

  - name: "ğŸ“‹ Prod Inventory Preview (first 30 lines)"
    debug:
      msg: "{{ (prod_inventory.content | b64decode).split('

        ')[:30] | join('

        ') }}"
    when: prod_inventory is defined and final_inventory_check.results[2].stat.exists
