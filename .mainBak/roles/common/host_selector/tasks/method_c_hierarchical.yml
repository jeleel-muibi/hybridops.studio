---
# SPDX-License-Identifier: MIT-0
# Author: Jeleel Muibi (hybridops.studio)
# Created: 2025-09-10 21:40:00 UTC
# Updated: 2025-09-10 — Initial implementation of Method C (hierarchical browsing)
#
# Purpose: Navigate categories → groups and set target_hosts.

- name: Cache category keys (order as provided)
  set_fact:
    category_keys: "{{ categories.keys() | list }}"

- name: Build category menu
  set_fact:
    category_menu: |-
      Select category:
      {% for i in range(category_keys | length) %}
      [{{ i + 1 }}] {{ categories[category_keys[i]].name }}
      {% endfor %}

      Enter category number:

- name: Prompt for category
  pause:
    prompt: "{{ category_menu }}"
  register: category_input

- name: Validate category input is numeric
  fail:
    msg: "Invalid input. Enter a number 1..{{ category_keys | length }}."
  when: not ((category_input.user_input | default('') | trim) is match('^\\d+$'))

- name: Validate and set selected category
  set_fact:
    selected_category_index: "{{ (category_input.user_input | int) - 1 }}"
  failed_when: >
    (selected_category_index | int) < 0 or (selected_category_index | int) >= (category_keys | length)

- name: Set selected category key
  set_fact:
    selected_category_key: "{{ category_keys[selected_category_index | int] }}"

- name: Build group menu for category
  set_fact:
    group_menu: |-
      {{ categories[selected_category_key].name }} — Select group:
      {% for i in range(categories[selected_category_key].groups | length) %}
      [{{ i + 1 }}] {{ categories[selected_category_key].groups[i] }}
      {% endfor %}

      Enter group number:

- name: Prompt for group
  pause:
    prompt: "{{ group_menu }}"
  register: group_input

- name: Validate group input is numeric
  fail:
    msg: "Invalid input. Enter a number 1..{{ (categories[selected_category_key].groups | length) }}."
  when: not ((group_input.user_input | default('') | trim) is match('^\\d+$'))

- name: Validate and set selected group
  set_fact:
    group_index: "{{ (group_input.user_input | int) - 1 }}"
  failed_when: >
    (group_index | int) < 0 or (group_index | int) >= (categories[selected_category_key].groups | length)

- name: Set final group name
  set_fact:
    selected_group: "{{ categories[selected_category_key].groups[group_index | int] | default('') }}"

- name: Set hosts from hierarchical selection
  set_fact:
    target_hosts: "{{ groups[selected_group] | default([]) }}"
