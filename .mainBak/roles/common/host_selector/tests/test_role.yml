---
# ==============================================================================
# Environment Guard Framework - Role Test (host_selector)
# Smoke-tests the host_selector role with interactive or automated environment input.
# Author: Jeleel Muibi | Last Updated: 2025-09-10 21:55:00 UTC
# ==============================================================================
# SPDX-License-Identifier: MIT-0

- name: Test Host Selector Role
  hosts: localhost
  gather_facts: false

  pre_tasks:
  - name: Prompt for environment (skip if already provided)
    pause:
      prompt: "Enter environment (e.g., staging, dev, prod):"
    register: env_input
    when: validated_env is not defined

  - name: Set validated_env
    set_fact:
      validated_env: "{{ env_input.user_input | lower | trim }}"
    when: validated_env is not defined

  - name: Ensure environment is not empty
    fail:
      msg: "validated_env is required for host_selector smoke test."
    when: (validated_env | default('')) | length == 0

  roles:
  - role: ../../ # role under test

  post_tasks:
  - name: Display selected hosts
    debug:
      msg: "Selected Hosts: {{ selected_hosts | default([]) }}"

  - name: Show correlation ID (if CID logging enabled)
    when: host_selector_use_cid | default(false)
    debug:
      msg: "[cid={{ cid | default('unset') }}] host_selector run"

  - name: Verify host selection
    assert:
      that:
      - selected_hosts is defined
      - selected_hosts | length > 0
      - (groups['targets_to_ping'] | default([])) | length > 0
      - host_selector_success | default(false)
      success_msg: "Host selection successful: {{ selected_hosts | length }} hosts selected"
      fail_msg: "Host selection failed"
