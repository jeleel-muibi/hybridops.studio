---
# =============================================================================
# Environment Guard Framework - CI Test (non-interactive)
# Runs the env_guard role without prompts. Target env from CI_ENV (default: dev).
# Author: Jeleel Muibi | Last Updated: 2025-09-10 21:20:00 UTC
# =============================================================================
# SPDX-License-Identifier: MIT-0

- name: Environment Guard - CI Validation
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    target_environment: "{{ (lookup('env','CI_ENV') | default('dev', true)) | lower }}"
    framework_version: "2.1.3"

  tasks:
  - name: Initialize CI session
    debug:
      msg: |
        Environment Guard CI Validation
        Version: {{ framework_version }}
        CI_ENV (env var): {{ lookup('env','CI_ENV') | default('unset', true) }}
        Target environment: {{ target_environment }}

  - name: Execute env_guard role (non-interactive)
    include_role:
      name: common/env_guard
    vars:
      env: "{{ target_environment }}"

  - name: Validate framework response
    assert:
      that:
      - validated_env == target_environment
      - env_guard_passed == true
      - env_guard_risk_score is defined
      - env_guard_correlation_id is defined
      - env_guard_correlation_id is match("^[0-9a-f-]{36}$|^envguard-[0-9]+-[0-9a-f]{12}$")
      fail_msg: "Framework validation failed"
      success_msg: "Framework validation completed"

  - name: Calculate paths
    set_fact:
      framework_log_path: "{{ (playbook_dir | regex_replace('/common/playbooks.*$', '') | regex_replace('/roles/.*$', '')) + '/common/logs/env_guard_logs' }}"
      test_output_path: "{{ playbook_dir }}/output"

  - name: Create test output directory
    file:
      path: "{{ test_output_path }}"
      state: directory
      mode: '0755'

  - name: Find latest run folder
    find:
      paths: "{{ framework_log_path }}"
      file_type: directory
      patterns: "2025*"
      use_regex: false
    register: run_dirs

  - name: Set latest run path
    set_fact:
      latest_run_path: "{{ (run_dirs.files | sort(attribute='path') | reverse)[0].path }}"

  - name: Copy audit log and report to test output folder
    copy:
      remote_src: true
      src: "{{ item }}"
      dest: "{{ test_output_path }}/"
      mode: '0644'
    loop:
    - "{{ latest_run_path }}/env_guard_audit.log"
    - "{{ lookup('fileglob', latest_run_path + '/env_guard_report_*.md') }}"

  - name: CI validation complete
    debug:
      msg: |
        ENVIRONMENT GUARD CI TEST COMPLETED
        Target: {{ validated_env }} | Risk: {{ env_guard_risk_score }}/10 | CID: {{ env_guard_correlation_id }}
        Audit: {{ test_output_path }}/env_guard_audit.log
        Reports: {{ test_output_path }}/env_guard_report_*.md
