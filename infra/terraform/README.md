# Terraform / Terragrunt Layout (`infra/terraform`)

**Owner:** HybridOps.Studio  
**Scope:** Proxmox, Azure, GCP stacks for `dev`, `staging`, `prod`.

---

## 1. Structure

```text
infra/terraform/
  live-v1/          # Terragrunt live tree
  modules/          # Reusable Terraform modules
```

### 1.1 Live tree (`live-v1`)

```text
live-v1/
  terragrunt.hcl          # root: backend + shared locals
  dev/
    terragrunt.hcl
    00-foundation/
      proxmox/sdn/        # SDN vnet descriptors
      azure/network/      # RG + VNet + subnets
      gcp/network/        # VPC + subnet
    10-platform/
      proxmox/vm/         # k3s VMs from Proxmox templates
      azure/aks/          # AKS cluster
      gcp/gke/            # GKE cluster
  staging/… (same pattern)
  prod/…    (same pattern)
```

Root `live-v1/terragrunt.hcl`:

- Reads Proxmox connection from environment:
  - `PROXMOX_URL`, `PROXMOX_TOKEN_ID`, `PROXMOX_TOKEN_SECRET`, `PROXMOX_NODE`, `PROXMOX_STORAGE_VM`.
- Configures **local** state:
  - `infra/terraform/live-v1/.terragrunt-state/{path_relative_to_include()}.tfstate`.

Env roots (`dev/staging/prod/terragrunt.hcl`):

- `include "root"` → inherit backend and Proxmox locals.
- Set `locals.environment = "dev" | "staging" | "prod"`.

---

## 2. Modules (summary)

All modules live under `infra/terraform/modules`:

- **Proxmox SDN** — `modules/proxmox/sdn`  
  SDN vnet model (name, VLAN, CIDR). Exposes `vnet_names["vnet-<env>-linux"].{ name, vlan_id, cidr }`.  
  Does *not* change host networking (Ansible owns vmbr / SDN).

- **Proxmox VMs** — `modules/proxmox/vm`  
  Manages real Proxmox VMs (`proxmox_vm_qemu`) from a template, and exposes a `vm_specs` list for audit/export.

- **Azure network** — `modules/azure/network`  
  Resource group, VNet, kube subnet, VM subnet.

- **Azure AKS** — `modules/azure/aks`  
  AKS cluster attached to an existing subnet.

- **GCP network** — `modules/gcp/network`  
  VPC and kube subnet in one region.

- **GCP GKE** — `modules/gcp/gke`  
  Regional GKE cluster + node pool.

---

## 3. Environment and secrets

Terraform / Terragrunt consume, but do not create, secrets.

- **Proxmox**
  - Env file: `infra/env/.env.proxmox`  
  - Generated by: `control/tools/provision/init/init-proxmox-env.sh`  
  - Exposes `PROXMOX_URL`, `PROXMOX_TOKEN_ID`, `PROXMOX_TOKEN_SECRET`, `PROXMOX_NODE`, `PROXMOX_STORAGE_VM`, `PROXMOX_BRIDGE`.  
  - Loaded via `live-v1/terragrunt.hcl` using `get_env(...)`.

- **Azure / GCP**
  - `control/tools/provision/init/init-azure-env.sh` and `control/tools/provision/init/init-gcp-env.sh` prepare provider input  
    (e.g. `.auto.tfvars.json` files and environment variables).
  - Authentication is handled by Azure/GCP CLIs and secret backends (AKV, SOPS).

Further detail:

- `infra/env/README.md`  
- `docs/guides/secrets-lifecycle.md`  
- `docs/adr/ADR-0020_secrets-strategy_akv-now_sops-fallback_vault-later.md`

---

## 4. Typical usage

All commands are run from the repository root.

### 4.1 Proxmox (dev)

```bash
# Load Proxmox connection
set -a
. infra/env/.env.proxmox
set +a

# Foundation: SDN vnets
cd infra/terraform/live-v1/dev/00-foundation/proxmox/sdn
terragrunt plan

# Platform: k3s VM cluster
cd ../../10-platform/proxmox/vm
terragrunt plan
```

### 4.2 Azure (dev)

```bash
# Azure auth + init-azure-env.sh already run

cd infra/terraform/live-v1/dev/00-foundation/azure/network
terragrunt plan

cd ../../10-platform/azure/aks
terragrunt plan
```

### 4.3 GCP (dev)

```bash
# GCP auth + GCP_PROJECT_ID set

cd infra/terraform/live-v1/dev/00-foundation/gcp/network
terragrunt plan

cd ../../10-platform/gcp/gke
terragrunt plan
```
